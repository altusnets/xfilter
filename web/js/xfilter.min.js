/*!
 *  xfilter 0.1.0
 *  http://att.github.io/xfilter/
 *  Copyright (c) 2012-2013 AT&T Intellectual Property
 *
 *  Licensed under the MIT License
 *  https://github.com/att/xfilter/blob/master/LICENSE
 */

!function(){function n(){"use strict";function n(n){var e,t,r,i={},u={},o=17;function a(e){return n+"/"+e}function c(n){return d3.json(a(n))}var f={};function s(n,e){return n.key<e.key?-1:n.key>e.key?1:n.key>=e.key?0:NaN}return f.dimension=function(n){if(!Object.keys(t).length)throw new Error("no schema (not started)");if(!t[n])throw new Error("field "+n+" not found in schema");function e(t){return r[n]?t instanceof Array?t.map(e):r[n].to(t):t}return{filter:function(e){if(null!==e)throw new Error("unexpected non-null filter()");return delete i[n],this},filterExact:function(t){return t=e(t),i[n]={type:"set",target:[t]},this},filterMultiple:function(t){return t=e(t),i[n]={type:"set",target:t},this},filterRange:function(t){return t=e(t),i[n]={type:"interval",target:t},this},filterFunction:function(){throw new Error("filter functions not allowed")},dispose:function(){return this.filter(null),this},group:function(){return function(n){var e=o++,t={id:e,dimension:n,values:null,splitter:"a"};u[e]=t;var r={categorical:function(){return this.dive([],1),this},dispose:function(){return delete u[e],t.values=null,this},all:function(){return t.values}};return f.engine().augment_group&&(r=f.engine().augment_group(t,r)),r}(n)}}},f.commit=function(){var n=Object.keys(u),e=[];for(var t in u)e.push(f.engine().build_query(i,u[t]));return function(n){return Promise.all(n.map(function(n){return d3.json(a(n))}))}(e).then(function(t){if(t.length!==e.length)throw new Error("unexpected number of results "+t.length);for(var i=0;i<t.length;++i){var o=t[i],a=n[i],c=u[a],f=r[c.dimension];c.values=o.root.children.map(function(n){return{key:n.path[0],value:n.val}}).sort(s).map(function(n){return{key:f?f.fro(n.key):n.key,value:n.value}})}return function(n){function e(){for(var e=n,t=0;t<arguments.length;++t){if(!e[arguments[t]])return console.log("expected data."+Array.prototype.slice.call(arguments,0,t).join(".")),!1;e=e[arguments[t]]}return!0}e("layers"),e("root","children")}(o)&&o,t})},f.engine=function(n){return arguments.length?(e=n,f):e},f.start=function(){return f.engine().fetch_schema(c).then(function(n){({fields:t,xform:r}=n)})},f}return n.version="0.1.0",n.nanocube_queries=function(){var n,e;return{build_query:function(n,e){var t=["count"];for(var r in n)if(!e||e.dimension!==r){var i;switch(n[r].type){case"set":i="set("+n[r].target.join(",")+")";break;case"interval":i="interval("+n[r].target.join(",")+")"}t.push('.r("'+r+'",'+i+")")}return e.print&&t.push("."+e.splitter+'("'+e.dimension+'",'+e.print()+")"),t.join("")},fetch_schema:function(t){return t("schema").then(function(t){var r={},i={};return t.fields.forEach(function(t){if(r[t.name]=t,/^nc_dim_cat_/.test(t.type)){var u=[];for(var o in t.valnames)u[t.valnames[o]]=o;i[t.name]={to:function(n){return t.valnames[n]},fro:function(n){return u[n]||"foo"}}}else/^nc_dim_time_/.test(t.type)&&(i[t.name]={to:function(t){return Math.round((t.getTime()-n)/e)},fro:function(t){return new Date(n+t*e)}})}),t.metadata.forEach(function(t){if("tbin"===t.key){var r,i=t.value.split("_");if(n=Date.parse(i[0]+" "+i[1]),r=/^([0-9]+)([a-z]+)$/.exec(i[2])){var u=function(n){var e=1;switch(n){case"w":e*=7;case"d":e*=24;case"h":e*=60;case"m":e*=60;case"s":return 1e3*e;default:return NaN}}(r[2]);e=+r[1]*u}}}),{fields:r,xform:i}})},augment_group:function(t,r){function i(n){var e=Array.prototype.slice.call(arguments,1);return function(){return n+"("+e.map(JSON.stringify).join(",")+")"}}return Object.assign(r,{dive:function(n,e){return t.print=i("dive",n,e),t.splitter="a",this},mt_interval_sequence:function(n,e,r){return t.print=i("mt_interval_sequence",n,e,r),t.splitter="r",this},time:function(t,r,i){t=t?t.getTime():n,r=r||e,i=i||3650;var u=(t-n)/e,o=r/e;return this.mt_interval_sequence(u,o,i),this}})}}},n}"function"==typeof define&&define.amd?define([],n):"object"==typeof module&&module.exports?module.exports=n():this.xfilter=n()}();
//# sourceMappingURL=xfilter.min.js.map