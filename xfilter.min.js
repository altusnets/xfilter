/*!
 *  xfilter 0.2.2
 *  http://att.github.io/xfilter/
 *  Copyright (c) 2012-2013 AT&T Intellectual Property
 *
 *  Licensed under the MIT License
 *  https://github.com/att/xfilter/blob/master/LICENSE
 */

!function(){function e(){"use strict";function e(e){var n,t,r,i={},u={},o=17;function a(n){return e+"/"+n}var f={};function c(e,n){return e.key<n.key?-1:e.key>n.key?1:e.key>=n.key?0:NaN}return f.dimension=function(e){if(!Object.keys(t).length)throw new Error("no schema (not started)");if(!t[e])throw new Error("field "+e+" not found in schema");function n(t){return r[e]?t instanceof Array?t.map(n):r[e].to(t):t}return{filter:function(n){if(null!==n)throw new Error("unexpected non-null filter()");return delete i[e],this},filterExact:function(t){return t=n(t),i[e]={type:"set",target:[t]},this},filterMultiple:function(t){return t=n(t),i[e]={type:"set",target:t},this},filterRange:function(t){return t=n(t),i[e]={type:"interval",target:t},this},filterFunction:function(){throw new Error("filter functions not allowed")},dispose:function(){return this.filter(null),this},group:function(){return function(e){var n=o++,t={id:n,dimension:e,values:null,splitter:"a"};u[n]=t;var r={categorical:function(){return this},dispose:function(){return delete u[n],t.values=null,this},all:function(){return t.values}};return f.engine().augment_group&&(r=f.engine().augment_group(t,r)),r}(e)}}},f.commit=function(){var e=Object.keys(u),n=[];for(var t in u)n.push(f.engine().do_query(a,i,u[t]));return Promise.all(n).then(function(t){if(t.length!==n.length)throw new Error("unexpected number of results "+t.length);for(var i=0;i<t.length;++i){var o=t[i],a=e[i],l=u[a],s=r[l.dimension];l.values=f.engine().unpack_result(o).sort(c).map(function(e){return{key:s?s.fro(e.key):e.key,value:e.value}})}return function(e){function n(){for(var n=e,t=0;t<arguments.length;++t){if(!n[arguments[t]])return console.log("expected data."+Array.prototype.slice.call(arguments,0,t).join(".")),!1;n=n[arguments[t]]}return!0}n("layers"),n("root","children")}(o)&&o,t})},f.engine=function(e){return arguments.length?(n=e,f):n},f.start=function(){return f.engine().fetch_schema(a).then(function(e){({fields:t,xform:r}=e),r=r||{}})},f}return e.version="0.2.2",e.nanocube_queries=function(){var e,n;return{do_query:function(e,n,t){var r=["count"];for(var i in n)if(!t||t.dimension!==i){var u;switch(n[i].type){case"set":u="set("+n[i].target.join(",")+")";break;case"interval":u="interval("+n[i].target.join(",")+")"}r.push('.r("'+i+'",'+u+")")}return t.print&&r.push("."+t.splitter+'("'+t.dimension+'",'+t.print()+")"),d3.json(e(r.join("")))},unpack_result:function(e){return e.root.children.map(function(e){return{key:e.path[0],value:e.val}})},fetch_schema:function(t){return d3.json(t("schema")).then(function(t){var r={},i={};return t.fields.forEach(function(t){if(r[t.name]=t,/^nc_dim_cat_/.test(t.type)){var u=[];for(var o in t.valnames)u[t.valnames[o]]=o;i[t.name]={to:function(e){return t.valnames[e]},fro:function(e){return u[e]||"foo"}}}else/^nc_dim_time_/.test(t.type)&&(i[t.name]={to:function(t){return Math.round((t.getTime()-e)/n)},fro:function(t){return new Date(e+t*n)}})}),t.metadata.forEach(function(t){if("tbin"===t.key){var r,i=t.value.split("_");if(e=Date.parse(i[0]+" "+i[1]),r=/^([0-9]+)([a-z]+)$/.exec(i[2])){var u=function(e){var n=1;switch(e){case"w":n*=7;case"d":n*=24;case"h":n*=60;case"m":n*=60;case"s":return 1e3*n;default:return NaN}}(r[2]);n=+r[1]*u}}}),{fields:r,xform:i}})},augment_group:function(t,r){function i(e){var n=Array.prototype.slice.call(arguments,1);return function(){return e+"("+n.map(JSON.stringify).join(",")+")"}}return Object.assign({},r,{dive:function(e,n){return t.print=i("dive",e,n),t.splitter="a",this},mt_interval_sequence:function(e,n,r){return t.print=i("mt_interval_sequence",e,n,r),t.splitter="r",this},time:function(t,r,i){t=t?t.getTime():e,r=r||n,i=i||3650;var u=(t-e)/n,o=r/n;return this.mt_interval_sequence(u,o,i)},categorical:function(){return r.categorical(),this.dive([],1)}})}}},e.fgb_queries=function(){return{do_query:function(e,n,t){var r={filter:{},groupby:[t.dimension]};for(var i in n)if(!t||t.dimension!==i){if("set"!==n[i].type)throw new Error("don't know how to handle filter type "+n[i].type);r.filter[i]=n[i].target}return d3.json(e("query"),{method:"POST",headers:{"Content-type":"application/json; charset=UTF-8"},body:JSON.stringify(r)})},unpack_result:function(e){return e.map(function(e){return{key:e[0],value:e[1]}})},fetch_schema:function(e){return d3.text(e("")).then(function(e){var n=e.indexOf(" ");e.slice(0,n);return{fields:JSON.parse(e.slice(n+1).replace(/'/g,'"')).reduce(function(e,n){return e[n]=!0,e},{}),xform:{}}})}}},e.filter_handler=function(e,n){return 0===n.length?e.filter(null):1!==n.length||n[0].isFiltered?1===n.length&&"RangedFilter"===n[0].filterType?e.filterRange(n[0]):e.filterMultiple(n):e.filterExact(n[0]),n},e}"function"==typeof define&&define.amd?define([],e):"object"==typeof module&&module.exports?module.exports=e():this.xfilter=e()}();
//# sourceMappingURL=xfilter.min.js.map