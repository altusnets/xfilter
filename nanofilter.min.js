/*!
 *  nanofilter 0.0.1
 *  http://gordonwoodhull.github.io/nanofilter/
 *  Copyright (c) 2012-2013 AT&T Intellectual Property
 *
 *  Licensed under the Eclipse Public License
 *  https://github.com/gordonwoodhull/nanofilter/blob/master/LICENSE
 */

function nanofilter(a,b,c){function d(c){return"http://"+a+":"+b+"/"+c}function e(a,b){d3.json(d(a),b)}function f(a,b){var c=queue();a.forEach(function(a){c.defer(d3.json,d(a))}),c.await(b)}function g(a){var b=["count"];for(var c in q)if(!a||a.dimension!==c){var d;switch(q[c].type){case"set":d="set("+q[c].target.join(",")+")";break;case"interval":d="interval("+q[c].target.join(",")+")"}b.push('.r("'+c+'",'+d+")")}return a.print&&b.push('.a("'+a.dimension+'",'+a.print()+")"),b.join("")}function h(a){function b(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a+"("+b.map(JSON.stringify).join(",")+")"}}var c=s++,d={id:c,dimension:a,values:null};return r[c]=d,{mt_interval_sequence:function(a,c,e){return d.print=b("mt_interval_sequence",a,c,e),this},dive:function(a,c){return d.print=b("dive",a,c),this},time:function(a,b,c){a=a?a.getTime():m,b=b||n,c=c||3650;var d=(a-m)/n,e=b/n;return this.mt_interval_sequence(d,e,c),this},categorical:function(){return this.dive([],1),this},dispose:function(){return delete r[c],d.values=null,this},all:function(){return d.values}}}function i(a){function b(){for(var b=a,c=0;c<arguments.length;++c){if(!b[arguments[c]])return console.log("expected data."+Array.prototype.slice.call(arguments,0,c).join(".")),!1;b=b[arguments[c]]}return!0}b("layers"),b("root","children")}function j(a,b){return a.key<b.key?-1:a.key>b.key?1:a.key>=b.key?0:NaN}var k,l,m,n,o={},p={},q={},r={},s=17,t={};return t.dimension=function(a){function b(c){return p[a]?c instanceof Array?c.map(b):p[a].to(c):c}if(!k)throw new Error("no schema");if(!k.fields.find(function(b){return b.name===a}))throw new Error("field "+a+" not found in schema");return{filter:function(b){if(null!==b)throw new Error("unexpected non-null filter()");return delete q[a],this},filterExact:function(c){return c=b(c),q[a]={type:"set",target:[c]},this},filterMultiple:function(c){return c=b(c),q[a]={type:"set",target:c},this},filterRange:function(c){return c=b(c),q[a]={type:"interval",target:c},this},filterFunction:function(){throw new Error("filter functions not allowed")},dispose:function(){return this.filter(null),this},group:function(){return h(a)}}},t.commit=function(a){var b=Object.keys(r),c=[];for(var d in r)c.push(g(r[d]));f(c,function(d){if(d)throw new Error(d);if(arguments.length!==c.length+1)throw new Error("unexpected number of arguments "+arguments.length);for(var e=1;e<arguments.length;++e){var f=arguments[e],g=b[e-1],h=r[g],k=p[h.dimension];h.values=f.root.children.map(function(a){return{key:a.path[0],value:a.val}}).sort(j).map(function(a){return{key:k?k.fro(a.key):a.key,value:a.value}})}!d&&i(f)&&(l=f),a(d,f)})},e("schema",function(a,b){a?c(a,b):(k=b,k.fields.forEach(function(a){if(o[a.name]=a,/^nc_dim_cat_/.test(a.type)){var b=[];for(var c in a.valnames)b[a.valnames[c]]=c;p[a.name]={to:function(b){return a.valnames[b]},fro:function(a){return b[a]}}}else/^nc_dim_time_/.test(a.type)&&(p[a.name]={to:function(a){return Math.round((a.getTime()-m)/n)},fro:function(a){return new Date(m+a*n)}})}),k.metadata.forEach(function(a){if("tbin"===a.key){var b=a.value.split("_");m=Date.parse(b[0]+" "+b[1]),/^[0-9]+s$/.test(b[2])&&(n=1e3*+b[2].substr(0,b[2].length-1))}}),c(a,b))}),t}
//# sourceMappingURL=nanofilter.min.js.map