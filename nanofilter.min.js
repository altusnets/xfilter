/*!
 *  nanofilter 0.0.1
 *  http://gordonwoodhull.github.io/nanofilter/
 *  Copyright (c) 2012-2013 AT&T Intellectual Property
 *
 *  Licensed under the Eclipse Public License
 *  https://github.com/gordonwoodhull/nanofilter/blob/master/LICENSE
 */

function nanofilter(a,b,c){function d(c){return"http://"+a+":"+b+"/"+c}function e(a,b){d3.json(d(a),b)}function f(a,b){var c=queue();a.forEach(function(a){c.defer(d3.json,d(a))}),c.await(b)}function g(a){var b=["count"];for(var c in r)if(!a||a.dimension!==c){var d;switch(r[c].type){case"set":d="set("+r[c].target.join(",")+")";break;case"interval":d="interval("+r[c].target.join(",")+")"}b.push('.r("'+c+'",'+d+")")}return a.print&&b.push("."+a.splitter+'("'+a.dimension+'",'+a.print()+")"),b.join("")}function h(a){function b(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a+"("+b.map(JSON.stringify).join(",")+")"}}var c=t++,d={id:c,dimension:a,values:null,splitter:"a"};return s[c]=d,{mt_interval_sequence:function(a,c,e){return d.print=b("mt_interval_sequence",a,c,e),d.splitter="r",this},dive:function(a,c){return d.print=b("dive",a,c),d.splitter="a",this},time:function(a,b,c){a=a?a.getTime():n,b=b||o,c=c||3650;var d=(a-n)/o,e=b/o;return this.mt_interval_sequence(d,e,c),this},categorical:function(){return this.dive([],1),this},dispose:function(){return delete s[c],d.values=null,this},all:function(){return d.values}}}function i(a){function b(){for(var b=a,c=0;c<arguments.length;++c){if(!b[arguments[c]])return console.log("expected data."+Array.prototype.slice.call(arguments,0,c).join(".")),!1;b=b[arguments[c]]}return!0}b("layers"),b("root","children")}function j(a,b){return a.key<b.key?-1:a.key>b.key?1:a.key>=b.key?0:NaN}function k(a){var b=1;switch(a){case"w":b*=7;case"d":b*=24;case"h":b*=60;case"m":b*=60;case"s":return 1e3*b;default:return NaN}}var l,m,n,o,p={},q={},r={},s={},t=17,u={};return u.dimension=function(a){function b(c){return q[a]?c instanceof Array?c.map(b):q[a].to(c):c}if(!l)throw new Error("no schema");if(!l.fields.find(function(b){return b.name===a}))throw new Error("field "+a+" not found in schema");return{filter:function(b){if(null!==b)throw new Error("unexpected non-null filter()");return delete r[a],this},filterExact:function(c){return c=b(c),r[a]={type:"set",target:[c]},this},filterMultiple:function(c){return c=b(c),r[a]={type:"set",target:c},this},filterRange:function(c){return c=b(c),r[a]={type:"interval",target:c},this},filterFunction:function(){throw new Error("filter functions not allowed")},dispose:function(){return this.filter(null),this},group:function(){return h(a)}}},u.commit=function(a){var b=Object.keys(s),c=[];for(var d in s)c.push(g(s[d]));f(c,function(d){if(d)throw new Error(d);if(arguments.length!==c.length+1)throw new Error("unexpected number of arguments "+arguments.length);for(var e=1;e<arguments.length;++e){var f=arguments[e],g=b[e-1],h=s[g],k=q[h.dimension];h.values=f.root.children.map(function(a){return{key:a.path[0],value:a.val}}).sort(j).map(function(a){return{key:k?k.fro(a.key):a.key,value:a.value}})}!d&&i(f)&&(m=f),a(d,f)})},e("schema",function(a,b){a?c(a,b):(l=b,l.fields.forEach(function(a){if(p[a.name]=a,/^nc_dim_cat_/.test(a.type)){var b=[];for(var c in a.valnames)b[a.valnames[c]]=c;q[a.name]={to:function(b){return a.valnames[b]},fro:function(a){return b[a]}}}else/^nc_dim_time_/.test(a.type)&&(q[a.name]={to:function(a){return Math.round((a.getTime()-n)/o)},fro:function(a){return new Date(n+a*o)}})}),l.metadata.forEach(function(a){if("tbin"===a.key){var b=a.value.split("_");n=Date.parse(b[0]+" "+b[1]);var c;if(c=/^([0-9]+)([a-z]+)$/.exec(b[2])){var d=k(c[2]);o=+c[1]*d}}}),c(a,b))}),u}
//# sourceMappingURL=nanofilter.min.js.map