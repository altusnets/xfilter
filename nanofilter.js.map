{"version":3,"sources":["src/nanofilter.js"],"names":[],"mappings":"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","file":"nanofilter.js","sourcesContent":["function nanofilter(server, port, k) {\n    var _schema, _fields = {}, _xform = {}, _filters = {}, _groups = {}, _data, _group_id = 17;\n\n    function query_url(q) {\n        return 'http://' + server + ':' + port + '/' + q;\n    }\n\n    function do_query(q, k) {\n        d3.json(query_url(q), k);\n    }\n\n    function do_queries(qs, k) {\n        var Q = queue();\n        qs.forEach(function(q) {\n            Q.defer(d3.json, query_url(q));\n        });\n        Q.await(k);\n    }\n\n    function build_query(group) {\n        var parts = ['count'];\n        for(var f in _filters) {\n            if(group && group.dimension === f)\n                continue;\n            var filter;\n            switch(_filters[f].type) {\n            case 'set':\n                filter = 'set(' + _filters[f].target.join(',') + ')';\n                break;\n            case 'interval':\n                filter = 'interval(' + _filters[f].target.join(',') + ')';\n                break;\n            }\n            parts.push('.r(\"' + f + '\",' + filter + ')');\n        }\n        if(group.type)\n            parts.push('.a(\"' + group.dimension + '\",' + group.type + '(' + group.args.join(',') + '))');\n        return parts.join('');\n    }\n\n    var nf = {};\n\n    nf.dimension = function(field) {\n        if(!_schema)\n            throw new Error('no schema');\n        if(!_schema.fields.find(function(f) { return f.name === field; }))\n            throw new Error('field ' + field + ' not found in schema');\n\n        function toValues(v) {\n            if(!_xform[field])\n                return v;\n            if(v instanceof Array)\n                return v.map(toValues);\n            return _fields[field].valnames[v];\n        }\n\n        return {\n            filter: function(v) {\n                if(v !== null)\n                    throw new Error('unexpected non-null filter()');\n                delete _filters[field];\n                return this;\n            },\n            filterExact: function(val) {\n                val = toValues(val);\n                _filters[field] = {type: 'set', target: [val]};\n                return this;\n            },\n            filterMultiple: function(vals) { // unique to nanocubes\n                vals = toValues(vals);\n                _filters[field] = {type: 'set', target: vals};\n                return this;\n            },\n            filterRange: function(range) {\n                range = toValues(range);\n                _filters[field] = {type: 'interval', target: range};\n                return this;\n            },\n            filterFunction: function() {\n                throw new Error('filter functions not allowed');\n            },\n            dispose: function() {\n                this.filter(null);\n                return this;\n            },\n            group: function() {\n                var _id = _group_id++, _anchor = {id: _id, dimension: field, values: null};\n                _groups[_id] = _anchor;\n\n                function capture(name) {\n                    return function() {\n                        _anchor.type = name;\n                        _anchor.args = Array.prototype.slice.call(arguments, 0);\n                        return this;\n                    };\n                }\n                return {\n                    mt_interval_sequence: capture('mt_interval_sequence'),\n                    dive: capture('dive'),\n                    dispose: function() {\n                        delete _groups[_id];\n                        _anchor.values = null;\n                        return this;\n                    },\n                    all: function() {\n                        return _anchor.values;\n                    }\n                };\n            }\n        };\n    };\n\n    function validate(data) {\n        function expect() {\n            var d = data;\n            for(var i = 0; i < arguments.length; ++i) {\n                if(!d[arguments[i]]) {\n                    console.log('expected data.' + Array.prototype.slice.call(arguments, 0, i).join('.'));\n                    return false;\n                }\n                d = d[arguments[i]];\n            }\n            return true;\n        }\n        expect('layers');\n        expect('root', 'children');\n    }\n\n    nf.commit = function(k) {\n        var ids = Object.keys(_groups), qs = [];\n        for(var id in _groups)\n            qs.push(build_query(_groups[id]));\n        do_queries(qs, function(error) {\n            if(error)\n                throw new Error(error);\n            if(arguments.length !== qs.length + 1)\n                throw new Error('unexpected number of arguments ' + arguments.length);\n\n            for(var i = 1; i < arguments.length; ++i) {\n                var result = arguments[i],\n                    id = ids[i-1],\n                    group = _groups[id],\n                    xform = _xform[group.dimension];\n                group.values = result.root.children.map(function(pv) {\n                    return {key: xform ? xform(pv.path[0]) : pv.path[0], value: pv.val};\n                });\n            }\n            if(!error && validate(result))\n                _data = result;\n            k(error, result);\n        });\n    };\n\n    do_query('schema', function(error, schema) {\n        if(error)\n            k(error, schema);\n        else {\n            _schema = schema;\n            _schema.fields.forEach(function(f) {\n                _fields[f.name] = f;\n                if(/^nc_dim_cat_/.test(f.type)) {\n                    var vn = [];\n                    for(var vname in f.valnames)\n                        vn[f.valnames[vname]] = vname;\n                    _xform[f.name] = function(v) {\n                        return vn[v];\n                    };\n                }\n            });\n            k(error, schema);\n        }\n    });\n\n    return nf;\n}\n"]}